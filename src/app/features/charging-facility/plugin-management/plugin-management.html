<!-- Error Message -->
@if (error(); as errorMsg) {
  <p-message
    severity="error"
    [text]="errorMsg"
    [closable]="true"
    (onClose)="clearError()"
  />
}

<!-- Loading State -->
@if (loading()) {
  <div class="loading-container">
    <p-progress-spinner ariaLabel="Loading plugin status..." />
    <p>Loading plugin status...</p>
  </div>
} @else {
  <!-- Main Table -->
  @if (pluginManagers(); as managers) {
    <div class="plugin-management-container">
      <!-- Header Actions -->
      <div class="header-actions">
        <h3>Plugin Management</h3>
        <p-button
          label="Clear All Connections"
          severity="warn"
          size="small"
          (onClick)="clearAllConnections()"
          [disabled]="operationInProgress()"
        />
      </div>

      <!-- Data Table -->
      <p-table [value]="managers" [loading]="operationInProgress()">
        <ng-template #header>
          <tr>
            @for (column of tableColumns; track column) {
              <th>{{ column }}</th>
            }
          </tr>
        </ng-template>

        <ng-template #body let-manager>
          <tr>
            <td>{{ manager.charger.id }}</td>
            <td>{{ manager.charger.name }}</td>
            <td>{{ manager.ev?.id ?? '-' }}</td>
            <td>{{ manager.ev?.name ?? '-' }}</td>
            <td>
              <p-button
                [severity]="getEvStatus(manager.status)"
                [label]="getPluginLabel(manager.status)"
                [disabled]="operationInProgress()"
                [loading]="operationInProgress()"
                (onClick)="togglePlugin(manager)"
              />
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  } @else {
    <p-message severity="info" text="No plugin data available" />
  }
}

@if (visibility) {
  <ev-plugin-modal
    [availableEvs]="availableEvs()"
    [selectedCharger]="selectedDevice()?.charger ?? null"
    (connectedEv)="handleConnection($event)"
    (modalClosed)="closeModal()"
  />
}

<p-toast />
